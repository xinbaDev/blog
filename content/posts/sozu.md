---
title: "调查开源服务器之sozu篇"
date: 2022-07-15T19:53:00+11:00
summary: sozu是一个Rust写的reverse proxy, 也是在caddy之后第二个我决定调查学习的开源代码项目。在看过caddy之后，我突然想查查在rust生态里面有没有nginx的替代品。rust的特点是没有GC，可以避免像其他语言服务器因为GC所产生的访问速度的波动。而且rust的语言特性也决定他比其他语言在内存相关的安全性上更高。于是花时间找了一下，初步结果是并没有找到一个特别成熟的项目可以完全取代nginx，更不要说满足我的要求了。但是我还是发现了一个很有潜力的reverse proxy, sozu。虽然学习的时间很短，但是依然打算记录一下。
draft: false
---

sozu是一个Rust写的reverse proxy, 也是在caddy之后第二个我决定调查学习的开源代码项目。在看过caddy之后，我突然想查查在rust生态里面有没有nginx的替代品。rust的特点是没有GC，可以避免像其他语言服务器因为GC所产生的访问速度的波动。而且rust的语言特性也决定他比其他语言在内存相关的安全性上更高。于是花时间找了一下，初步结果是并没有找到一个特别成熟的项目可以完全取代nginx，更不要说满足我的要求了。但是我还是发现了一个很有潜力的reverse proxy, sozu。虽然学习的时间很短，但是依然打算记录一下。

刚看到sozu的时候，主要还是被他的架构设计所吸引。他的main/worker分离的架构让我想起nginx的架构设计。一个server负责accept，然后通过loadbalance算法分配给多个单独运行的worker进程。而且worker也是单线程，使用eventloop来异步进行数据处理。这种架构设计给我不少好感，让我对使用的同样架构的sozu的性能有了不少期待。然后sozu还支持动态配置，不需要重启就可以对配置进行修改。而且比较有特色的是，sozu支持细粒度的配置修改，比如增加/去掉一个后端服务器，增加/去掉一个证书这种细粒度的配置修改，这样的好处是可以对不同的配置修改进行细化的处理。值得一提的是，sozu的高可靠性也是架构设计的一大目标，甚至在binary升级的时候，服务也不会中断。这些特性都是原来nginx不具备，但是十分有用的功能。

因为好奇，我大概看了一下他的代码，主要是一些我感兴趣的部分，比如worker和main是怎么通信的，worker如何启动，动态配置和升级的过程大致是怎么样的。初步的感觉是代码质量比caddy要高，相对易读。主要体现在想看的代码比较容易找到，整个代码的结构清晰。但是也有一些不太喜欢的地方，比如一些函数太长太宽，没有fmt，而且个别函数还有十几个参数，这些都影响了可读性。整个代码给我的感觉是还在不停迭代。应该说整个项目的代码量其实不大，但是commit却有4000多个，是caddy的3倍之多。但是功能上却比caddy少了不少。可以看出sozu在已有的代码上进行了不少的更改。

总的来说，我对sozu的印象不错，让我想起nginx的一些优秀的架构设计。甚至其中的一些通过command动态配置的设计让我想到了kubernetes。目前sozu还在不停的开发当中，已经有计划作为gateway来融入kubernetes的生态，还是值得期待的。sozu这个项目一开始是clever cloud公司的内部使用项目，后来开源。一开始的设计的需求是比较侧重可靠性和动态配置，但是模块化这块就没有看到。相比起caddy，sozu更像是一个专门的reverse proxy，不知道扩展性怎么样，但是目前看来并没有特别多模块化的功能。

总得来说，sozu是一个挺有趣的reverse proxy，看代码的时候让我想起以前读nginx代码的时光。但是我应该是不会选择sozu作为nginx的替代的，至少目前还不会。通过command的方式来细粒度的修改配置虽然有用，但是每一个配置都要去自己实现那也太麻烦了。还是caddy那种一个json文件的配置所有来的简单。