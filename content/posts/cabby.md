---
title: "调查开源服务器之caddy篇"
date: 2022-07-13T019:45:00+11:00
summary: 最近因为工作需要，接触到distributed tracing。看完后一系列文档后就计划也部署一套分布式监控系统以解决websocket一直以来奇怪的connection reset的报错。后来经过一些了解，发现目前使用的nginx服务器还没有很好的支持这个功能，于是打算干脆换一个服务器。
draft: false
---

最近因为工作需要，接触到distributed tracing。看完后一系列文档后就计划也部署一套分布式监控系统以解决websocket一直以来奇怪的connection reset的报错。后来经过一些了解，发现目前使用的nginx服务器还没有很好的支持这个功能，于是打算干脆换一个服务器。其实之前一直有替换nginx的打算，因为尽管nginx性能出众，但是是用c语言写的，配置扩展都不是特别方便。比如分布式监控这一块就不能很容易的添加。还有一些其他不方便的地方，比如dropbox就曾经记录过他们更换nginx的[理由以及更换的过程](https://dropbox.tech/infrastructure/how-we-migrated-dropbox-from-nginx-to-envoy)。总之nginx并不是非常好维护。

于是开始调查目前新的主流的开源服务器。印象中之前碰到过Golang开发的服务器，似乎整体评价不错，而且go以高并发著称，很适合服务器的场景，在加上我对go也比较熟悉，所以就锁定在go开发的一些服务器上。很快就找到一些nginx alternative, 其中以go语言开发的就有好几个，比如caddy, traefik等。综合比较了一下，感觉caddy比较Promising, 不仅功能强大，而且支持动态配置。最重要的是支持opentelemetry，这个我查了下traefik目前都还没有很好支持。大致了解了一下caddy的设计思路和架构，很快就引起了我的兴趣。在加上代码量似乎也不大，总共就1000多个commits, 这里面大多数是module的代码，核心方面的代码就更少了。于是就打算开始阅读caddy的代码，尤其是了解分布式监控那部分代码。

但是我很快就发现caddy似乎并不容易读。分布式监控那块到是比较简单，只要了解opentelemetry的大致的工作机制和如何调用就可以比较轻松的看懂。但是caddy核心部分的代码就比较难理解了。也许是习惯了类型明确的函数声明，在caddy经常可以看到函数返回的变量类型是interface{}这种，看起来不太习惯。而且也存在一些特别长的函数看起来比较累，可以看到一些XXXandXXX的函数命名，根据single responsiblity的原则，这个函数应该是可以拆开成两个函数的。印象中一些变量命名也不太规范，出现过短，意义不明，不一致的情况。总体来说感觉质量并不好，不过毕竟是多人开发的开源项目所以也可以理解。caddy的一些独特的设计和特点，挺有意思的，所以相比阅读起来的一些不便，整体上还是瑕不掩玉，值得花时间一读的。

caddy有一些比较有特点的features，比如支持使用json进行动态配置，具体来说就是可以很方便的使用json文档通过打api的形式来实时配置。在caddy会通过LoadModule的函数，将json通过unmarshal的方式转成内存中的instance。这一块设计的好处是不需要写复杂的parser来处理专门的配置文件，已经有许多现成的Lib可以实现配置文件到module instance的转换。但是使用json的坏处是当json配置增多，indent也会变多，而且不能分开管理而是全部放在一个json文件中，看起来就很累也不方便维护。为此caddy也提供了专门caddyfile的专属配置格式，更加适合人去使用。

caddy另一个特色设计就是模块化的架构。caddy的模块十分灵活，每一个模块都有自己life cycle, 包括load phase, provision/validation phase, use phase, cleanup phase。模块下面又可能包括子模块。当模块被import的时候，模块里的init函数被触发，然后通过RegisterModule函数注册这个moudle。得益于这个模块系统，可以很方便的通过模块的方式添加新功能。caddy中有不少模块，其中最重要的就是caddyhttp和tls模块，也是最早计加入的两个模块。caddyhttp应该是caddy里面最核心也最重要的模块，主要负责http请求。但是tls才是caddy的其中一个主要卖点，主要解决tls链接以及cert管理的功能。管理cert是比较麻烦的，尤其是服务器多，而且需要几个月更新一次的情况下。以最常用的免费let encrypted证书为例，每三个月就要更新一次。虽然可以用certbot自动化，但是毕竟每新增一个服务器就要重新配置一次，比较麻烦。而且一些内部服务器，没有对外端口，每次更新证书还要去打开端口，否则自动更新就会失败。caddy的tls模块就可以解决这个问题。

总的来说，caddy的功能强大，基本上我需要的功能caddy都能够提供，包括loadbalancing/reverse proxying, rate limit， websocket, tls, monitoring等等, 而且方便扩展。根据caddy官网介绍，caddy已经在生产服务器上运行一段时间了，可以算是battle test的产品。还有一个吸引我的地方是caddy的主要部分几乎没有对外的依赖，这样就减少了不少维护的成本。不过我对caddy的依然有一些保留，主要还是读代码的时候给我留下的印象不是太好，而且从性能上讲，caddy离nginx还是有不小差距。还有就是安全性，nginx的攻击面小，是身经百战了，这么多年也没有太多安全事故，而caddy还比较年轻，安全性肯定和nginx不能比的。caddy除了开源免费的版本外，还有一个商业版本，作者似乎把不小的精力放在商业版上了，这也让我对使用caddy有所保留。总之做为一个备选吧，继续在看看其他的选择。