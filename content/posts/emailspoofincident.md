---
title: "关于email被冒用的一次记录"
date: 2023-01-09T13:49:22+11:00
draft: false
summary: 最近公司的其中一个邮箱被人冒用，发送了许多垃圾邮件。因为在半夜发送，等发现的时候已经是第二天早上。邮箱里面塞满了从postmaster发过来的发送失败的邮件。一开始还以为邮箱被盗了，赶紧重置密码。但是后来又排除了这个可能。因为我们公司邮箱已经开启了2次验证，即使是密码泄漏黑客也没法登陆。仔细看了一下，发现基本上是spf都没有通过的邮件，所以应该是被冒用了。之后通过在microsoft exchange中查询退回邮件的mssageid也证实邮件并不是从我们这边发出。所以结论就是被冒用。
---

最近公司的其中一个邮箱被人冒用，发送了许多垃圾邮件。因为在半夜发送，等发现的时候已经是第二天早上。邮箱里面塞满了从postmaster发过来的发送失败的邮件。一开始还以为邮箱被盗了，赶紧重置密码。但是后来又排除了这个可能。因为我们公司邮箱已经开启了2次验证，即使是密码泄漏黑客也没法登陆。仔细看了一下，发现基本上是spf都没有通过的邮件，都是来自一些四类1agqewQ5HVuo.kasegpexve1agqewQ5HVuo.com.au的奇怪域名，判断应该是被冒用了。之后通过在microsoft exchange中查询退回邮件的mssageid也可以证实邮件并不是从我们这边的outlook邮箱发出。所以结论就是被冒用。其实邮箱冒用这个很常见了，因为邮件头是不加密的，好几年前我就试过修改邮件中的form以达到邮箱冒用。当时测试的是gmail，基本上以假乱真。当时还觉得挺好的玩，有一次投简历的时候还用对方公司的邮箱域名来发送，结果收到公司老板亲自打电话过来询问。可以看出，要冒用一个邮箱有多容易。不过我记得后来gmail也有改进，之后再要冒充就会被特别标识出来。总是冒用这个并不稀奇，我奇怪的是为什么冒用的邮件的退回邮件会发到我们的正常邮箱中来。按道理来说应该直接进垃圾箱就好。后来又仔细看了一下，返回的邮件基本上是说收件人的邮箱dns解析失败还有就是收件人的邮箱系统拒绝建立连接或者没有回应。我直觉这些错误邮件不应该发到我们的邮箱里面来，所以专门联系了microsoft support，但是接手的工程师也不是很明白，甚至怀疑postmaster@outlook.com这个邮箱做恶，明显不知道postmaster是一个系统邮箱这件事。一天过后postmaster发来的邮件就变少了，不知道是不是microsoft做了什么修改。

就在我以为已经告一段落的时候，前几天却发现公司outlook的邮件突然不能发邮件给gmail了。因为我们的客户有许多都是用gmail来联系，不能发送给gmail将会给业务带来很大的影响。如果说之前邮箱收到大量退回邮件还不算是一个事故，那不能发邮件给gmail绝对算是了。收到同事的消息后马上第一时间做了测试，使用公司的的邮箱发送邮件给自己的gmail邮箱，果然被挡了。当时就觉得麻烦了，因为gmail将我们的邮件当成垃圾邮件并阻断，怎么解封，什么时候解封都不是我们能够控制的。毕竟gmail对垃圾邮件的判断标准不公开，联系google解封邮箱也是很麻烦的事情。看网上的说法是至少要一两个星期才有可能。

我当时收到gmail退回邮件的消息后，看到550 5.7.1的错误报告，显示是由于非常低的domain reputation导致被当成垃圾邮件了。但是使用google提供的postmaster还有第三方的查询工具测试后却发现，domain的reputatoin并没有问题。唯一让人有些在意的是在上个月邮箱被冒用的那一天，域名的reputation在posrtmaster是medium。我继续测试，发现只有gmail收不到。其他的icloud, protonmail都可以正常接收outlook发出的email。还有就是再使用第三方email提供商用相同域名发送邮件时可以正常发送到gmail，gmail似乎只是针对outlook发出的邮件有限制。这些都让我觉得domain reputation可能不是真正的原因，或者说不是主要原因。反而邮件是从哪个邮箱服务提供商发出的邮件有很大的影响。在测试的时候我还接触到了一个测试邮件质量的工具，mxtoolbox。只要给ping@mxtoolbox.com发送一封邮件，就可以看到邮件配置的一些问题。网页上面还有其他许多工具，十分好用。通过这个工具，我发现我们outlook上的dkim没有aligned，签名的域名和发送邮件的邮箱域名并不相同。dkim使用非对称加密的方式来保证邮件内容不被修改，如果不去专门设置的话，microsoft就会用自己的key去加密。还有就是缺少dmarc的record。这个记录依赖语spf, dkim,只有开启了这两项dmarc才有用。主要是用来告诉邮箱接收方开启了spf,dkim，如何处理不符合条件的邮件，并提供一个邮箱来接收发送的情况。我对dmarc的理解是这个记录可以帮助邮箱接收方更好的处理垃圾邮件，作为发送方也可以得到邮件发送的情况反馈。这两个不足的地方，mxtoolbox都有提示出来，而且根据网上的一些说法，都可可以帮助提升邮件的质量，减少被当成垃圾邮件的可能。可惜测试之后并没有起到立竿见影的效果，从outlook发送邮件到gmail依然会被挡在外面。我在mxtoolbox上注意到，再发送邮件的时候我们的outlook邮箱服务器被blacklist的。于是我怀疑是不是这个问题，又再次联系microsoft support，问如何解除blacklist。这次接手的工程师也不是很清楚，在我描述完我的情况后截了一堆图，然后答应我说会咨询高级工程师然后下周一给我回复，因为当时已经是周五下班时间了。

但是我当然等不了，于是又继续测试。我发现在其他的测试blacklist的平台上，我们邮箱域名是没有问题的。而我使用自己私人的outlook邮箱发送给mxtoolbox的邮件却也显示blacklist, 而我的私人邮箱时可以正常发送邮件给gmail的。这让我怀疑mxtoolbox上blacklist的可信度。总之通过不断的测试研究，总是会发现一些相互冲突的evidence。这让我分析起来很困难。在确定我把能提高邮件质量的事情都做了之后，依然被gmail block之后。我给google提交了一份报告，并把被gmail错误标识成垃圾邮件的邮件header发给google。当然不能光等google解封，毕竟一天无法联系客户都有可能带来损失。因为之前发现第三方的邮件服务商时可以正常发送邮件给gmail的，不过那些只是用来发邮件，并不提供邮箱。于是我在google workplace上也开通了一个邮箱服务，再修改添加spf, dkim等信息之后，我发现通过gmail发送的邮件gmail是可以收到的。这样就解决了发送邮件的问题。剩下的问题就是如何同步outlook和gmail上的邮件。因为在就收邮件的时候依然是outlook的邮箱接收，需要一个方法把邮件转到gmail上。搜索到的方法大部分都是不同邮箱名之间的转移，并不适合我们相同邮箱名的情况。中间尝试了不少方法，比如直接在gmail的setting里面使用import，但是无论如何无法成功验证outlook的邮箱，中途我都把outlook邮箱的二次验证关了，也都不行。最后终于通过google提供的gwsmo+outlook desktop的方法实现了，原理是在outlook上同时登陆gmail和outlook的邮箱，添加一个redirect的rule，每次outlook收到邮件都转到gmail邮箱的本地文件夹里面。然后gswsmo这个plugin会周期性的同步gmail邮箱。这样就可以在gmail上收到邮件了。做好这个后终于可以松一口气，感觉掌控感又回到了我这边。

周一上班的时候microsoft support给我邮件说最近高级工程师回复比较慢，并表示抱歉。不过这时我不着急了，也对microsoft support不报太大的期望了。周二给我打来电话，说需要我自己去和blacklist邮箱的第三方申请移除黑名单。我表示感谢，然后说可以关掉这个case了。因为这个时候我发现已经又可以正常使用outlook发送邮件给gmail了。我猜gmail里面判断是否是垃圾邮件的算法应该是有和时间相关的参数, 所以需要等一段时间才会unblocked。经过这次incident, 让我对邮箱验证有了更多的认识。因为我接手的时候，公司的邮箱服务器就已经开好了，而且spf是一开始microsoft就会自动添加的。所以一直觉的没有问题。可见microsoft的邮箱安全性是不太行，这种攻击是可以用的到其他所有初始设置的outlook邮箱上的。