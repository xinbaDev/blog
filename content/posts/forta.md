---
title: "forta的工作流程和主要组件"
date: 2022-06-08T19:39:11+11:00
summary: 最近发现一个非常好用的开源区块链监控工具Forta，主要用于监控区块链上的transactions。我之前其实也写过类似监控工具供个人使用，但是和这个比起来就差远了。这些天花了不少时间阅读了这个工具的代码，对这个工具的工作流程和组成结构都有了大致的了解。个人非常喜欢他的架构设计，于是打算专写一篇文章记录一下这些天的学习成果，主要记录一些观察和思考。
draft: false
---

## 介绍

先介绍一下forta的代码概况还有我主要阅读的方向吧。到目前为止，forta大概已经开发了1年多些，总共的commit一共有1330个，主要开发者主要有两个，开发语言是GO。这并不是一个特别大的项目，而且功能也比较明确，主要用于监控，在加上GO本来就是一门工程性很强的语言，所以读起来其实并不太费力。我首先是从最新的master上的commit开始看，将整个项目的代码结构大致过了一遍，了解了一下其中主要的代码组件。尤其是一些让我感兴趣的功能代码，比如抓取区块链数据的那部分，我就会专门去找来看。完成这一步后，如果我对个项目还有兴趣，或者有些还不太明白，我会从第一个commit开始看，帮助我了解这个项目的架构是怎么一步步搭建起来的。对于forta这个项目，我大概看了几百个commits,中间也是挑着看，主要看一些涉及重要的功能的commit, 至于bugfix,refactor则一般都会跳过。在做完这一步后，我对forta的架构已经有了相当程度的了解，最后在回去看最新的commit，把之前看到的各种零星相对分散的理解全部整合起来。这时因为已经有了对代码框架的整体理解，就可以更加深入到一些代码的细节。因为我的目标是修改代码，使之可以在本地单机运行，所以我主要是侧重几个问题，比如agent是怎么注册的，如何配置本地agent, alert是如何发送的等等。

## forta工作流程和主要的组件

首先要运行forta，就要安装docker。在forta中大量运用到了docker，所有组件都是通过docker container的形式运行，包括agent都是如此。各个组建间通过grpc的方式进行通信，其中通信protocol的代码一开始也是在forta node的repo，后来单独独立出来到了另一个forta-core-go的repo，这里按下不表。forta在启动运行之前主要有两步，一是forta init, 主要是产生一个config文件在.forta文件下里面，二是forta register, 主要是将scanner注册到链上的registry合约中，这样scanner才可以被发现，然后assigner software(未开源)才会给其分配agent。
（这一步对于本地单机运行是不需要的）。在完成前两步之后就可以运行forta run让forta启动了。forta最先启动的是supervisor, 主要功能是监控接下来要运行的一些列container, 让他们保持运行。supervisor启动后会去启动其他组件，其中有ipfsContainer， natsContainer， jsonRpcContainer， scannerContainer，具体代码在services/supervisor/start.go的start()中。其中我主要关注的是scannerContainer，因为forta的主要的工作流程逻辑都在其中。scanner在启动的时候会初始化一系列服务，例如agentPool， AlertSender， registryService等等，具体可以看cms/scanner/main.go中的initServices函数。其中registryService会轮询链上相应的scanner合约上的agent资料，从而更新agentpool中的agent。可以说Scanner是forta中最重要的组件，其他组件都是或多或少通过scanner联系起来的。其工作的主要流程原理大致如下：

Scanner通过轮询的方式抓取block的数据，然后通过多个worker处理block中的transactions，将这个txs通过channel的方式发送给analyzer， analyzer根据EvaluateTxRequest protocol将tx转成request，通过agentpool发给所有的agents。agent在处理transaction的时候会调用invoke远程bot的method（也是通过grpc）来处理并将结果发送到TxResuls, 然后在analyzer中处理这个结果。然后把findings通过alertsender发送。最后alert发送会通过batch的方式批量的打到一个alert server, 这个assigner software一样目前也没有开源，唯一能找到的是一个相关server的mock test。如果要运行本地单机版的forta,这一块也是需要修改和补上的。

## forta架构的一些思考

forta的架构我非常欣赏，尤其是他将agent和scanner分开，每个agent单独运行在docker container的这种架构方式。我之前也用GO语言写过一个监控工具，但是所有功能都放在一起，既不方便扩展，也不方便维护。当然要做到forta这种架构并不容易，首先为了agent和scanner之间的沟通，需要专门写一个protocol，提高了编写程序难度。其次分布式的架构也对程序本身的监控提出了更高的要求。像forta这种分布式的架构（尤其是还牵涉到这能合约），对我来说还是比较少见的, 比如将一些数据保存在链上，一些保存在本地的做法就很少能看见。印象中看到上一个看到的类似的分布式项目还是nym(nym相比forta就更复杂了，因为他本身实现的是一个区块链的功能，而且还是用我还不太熟悉的rust写的)。通过对forta代码的追踪，可以发现forta一开始是OpenZeppelin团队内部开发的项目，中间项目该过几次名字，后来才慢慢演化成如今forta。通过对forta代码的改进，架构的演变的学习，就像读一本稍微超出我理解水平的书一样，让我收获不小。