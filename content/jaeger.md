---
Title: "From Jaeger to 'Mastering Distributed Tracing'"
Date: 2022-07-06T07:23:00+11:00
Summary: Recently, I encountered a strange problem at work. When upgrading a WebSocket, Nginx often reported an error indicating a peer connection reset, but it did not provide any specific reason for the error. This problem did not usually manifest itself, and I did not notice it during my testing, nor did I receive any user reports. It seems that this error is not noticeable to users. I searched online and found many similar problems, but none exactly matched the problem I encountered. I was very curious about the root cause of this problem, and I suspected that the application server reset the connection when Nginx proxy connected to it. However, there was no evidence, and the usual logs did not reveal anything, so I had to put it aside. Fortunately, I have some free time now, and I want to solve this problem. My plan is to add relevant monitoring to further narrow down where the problem occurred. That's when Jaeger came into my view.

draft: True
---

Recently, I encountered a strange problem at work. When upgrading a WebSocket, Nginx often reported an error indicating a peer connection reset, but it did not provide any specific reason for the error. This problem did not usually manifest itself, and I did not notice it during my testing, nor did I receive any user reports. It seems that this error is not noticeable to users. I searched online and found many similar problems, but none exactly matched the problem I encountered. I was very curious about the root cause of this problem, and I suspected that the application server reset the connection when Nginx proxy connected to it. However, there was no evidence, and the usual logs did not reveal anything, so I had to put it aside. Fortunately, I have some free time now, and I want to solve this problem. My plan is to add relevant monitoring to further narrow down where the problem occurred. That's when Jaeger came into my view.

Jaeger is a distributed monitoring tool that is industrial-grade. It is different from traditional monitoring tools as it mainly focuses on monitoring the running conditions of requests in microservices, rather than monitoring basic infrastructure such as CPU and memory. From this perspective, Jaeger's monitoring granularity is smaller and more context-rich. Jaeger has been developed for six years and is still adding new features. Although the overall framework is basically finalized, various backend support is still constantly increasing.  In Jaeger, I found that object creation likes to stack like a Matryoshka doll, frequently creating a new object that immediately becomes the parameter for the next object, layer upon layer, making the entire top-level object very complex. There is also object injection, such as with the SpanWriter, which can inject many objects, making it very flexible.

Through reading the source code during this period of time and my understanding of distributed tracing, I believe that besides the main components such as the agent and collector, the spanreader and spanwriter are the key focus. The agent and collector are the main members responsible for the operation and data exchange of the entire system, which can help understand how Jaeger works as a whole. However, to have a deeper understanding of how tracing works, it is necessary to study from the perspective of the spanwriter/spanreader. In addition, distributed tracing also relies on the client SDK, which needs to solve the problem of how to pass context. This includes passing context within the same program, as well as passing context between different machines. The goal of distributed tracing is to minimize the impact on the application as much as possible. As far as I know, many companies provide specially packaged request libraries for programmers to use, which includes monitoring, TLS, retrying, and other functions.

Recently, in order to learn Jaeger, I specifically found a book called "Mastering Distributed Tracing" to read. The author is one of the main developers of Jaeger and has rich experience in distributed monitoring in large companies such as Uber. After a rough read, I found that the content inside is very practical and I gained a lot from it. Among them, it mentioned the standards of distributed monitoring. At that time, in 2018, the standards had not yet been unified. However, now the dust has settled, and as far as I remember, the current industry standard for distributed monitoring is OpenTelemetry. I didn't delve very deeply into this standard, but only looked at some SDK code applications and had a preliminary intuitive understanding. Perhaps I can spend more time studying it in the future. There is really a lot to learn in this area.

"Scattered records of my learning and understanding of distributed tracing these days, returning to the problem encountered in the beginning of work. This problem is solved by distributed tracing, but because we use servers - one is Nginx and the other is Daphne - both of which are not written by us, it is not easy to add tracing. Upon checking, Nginx currently has [plans to integrate OpenTelemetry] (https://www.nginx.com/blog/integrating-opentelemetry-modern-apps-reference-architecture-progress-report/), while Daphne seems to lack dedicated OpenTelemetry support.

Perhaps it's time to consider trying a different WebSocket server?"